---
title: "Hierarchical Generalized Additive Models"
description: |
  This course is designed to demystify hierarchical modelling as powerful tools to model population dynamics, spatial distributions, and any non-linear relationships in your ecological data. The training will be divided into two blocks. First, we will cover hierarchies in biology, data, and in models to understand what hierarchical models are, some of the forms they can take, and the fundamentals of how they work. Second, we will introduce latent variable modelling as a way to explain even more of the variation in our response variables, to better disentangle the hierarchies of variation in our data. Both blocks will include a theoretical presentation followed by hands-on coding exercises to implement and interpret hierarchical GAMs.
author:
  - name: "Camille Lévesque"
    affiliation: Université de Sherbrooke
  - name: "Katherine Hébert"
    affiliation: McGill University
categories: [Technical, EN]
date: "03-03-2025"
image: image.jpg
toc: true
number-sections: true
number-depth: 1
---

# Overview

This course is designed to demystify hierarchical modelling as powerful tools to model population dynamics, spatial distributions, and any non-linear relationships in your ecological data. The training will be divided into two blocks.

1.  First, we will cover hierarchies in biology, data, and in models to understand what hierarchical models are, some of the forms they can take, and the fundamentals of how they work.

2.  Second, we will introduce latent variable modelling as a way to explain even more of the variation in our response variables, to better disentangle the hierarchies of variation in our data.

Both blocks will include a theoretical presentation followed by hands-on coding exercises to implement and interpret hierarchical GAMs.

This workshop was developed with support from the [NSERC CREATE Computational Biodiversity Science and Services (BIOS²)](https://bios2.usherbrooke.ca/) training program.

## Requirements

#### Familiarity with Generalized Additive Modelling 

We recommend previous experience with GAMs before taking this training. If you would like to follow an introduction to GAMs before this workshop, please have a look at Eric Pedersen’s [Introduction to GAMs](https://bios2.usherbrooke.ca/2021/10/20/workshop-gams-2021/) and/or the Québec Centre for Biodiversity Science’s [Workshop 8: GAMs](http://r.qcbs.ca/workshop08/book-en/).

#### R & RStudio

The workshop assumes basic familiarity with R/RStudio. To be able to follow along with the practical exercises on your own computer, in addition to downloading the data files above, you will need to do the following:

Install the latest version of R for your operating system: <https://cran.r-project.org/>. Install the latest version of RStudio for your operating system: <https://www.rstudio.com/products/rstudio/download/>

#### R packages

Install and load the packages that we will use during the workshop by executing the following code in R version 4.2.0:

```{r, eval = T, message = FALSE}
# install packages from CRAN

# install.packages(pkgs = c("mvgam", "mgcv", "gratia", "marginaleffects", "ggplot2"), dependencies = TRUE)
library("dplyr")
library("tidyr")
library("mvgam")
library("mgcv")
library("gratia")
library("marginaleffects")
library("ggplot2")
```

------------------------------------------------------------------------

# Workshop materials

## About the data set

In this workshop, we will be analyzing time series of a groundfish community in the Northwest Atlantic Newfoundland Shelf from 1980 to 2013. These data are published the article:

Pedersen Eric J., et al. (2017). Signatures of the collapse and incipient recovery of an overexploited marine ecosystem. *Proc. R. Soc. Open Sci.* 4170215. <http://doi.org/10.1098/rsos.170215>

For this workshop, we will work with a subset of 10 of the 30 species included in the article: *Anarhichas denticulatus, Gadus morhua, Glyptocephalus cynoglossus, Hippoglossoides platessoides, Raja spinicauda, Raja radiata, Raja senta, Reinhardtius hippoglossoides, Sebastes marinus, Sebastes mentella.*

### Data file setup and download

Load the prepared dataset:

```{r}
dat = readRDS(file = "data/fish-community.rds")
years = rownames(dat)
```

Plot the data to get a first look at how species' biomasses changed through time:

```{r}
matplot(dat, type="l", lty = 1, lwd = 2, col = rainbow(n = 10,v = .8),
        ylab = "Biomass", x = years)
```

------------------------------------------------------------------------

## Part 1: Hierarchical Generalized Additive Models (HGAMs)

### Prepare the data

First, the data needs to be prepared into a long format (i.e., one observation per row). Later (in Part 2), the `mvgam` package will require specific column names, so we will prepare the data to match the package's requirements.

```{r}
dat_l = dat |>
  
  # First, we need a "time" column to index the observations at each time step
  mutate("time" = years) |> # make a new column with year values
  
  # Convert to long format
  pivot_longer(cols = -time, # only apply to species' biomass columns
               
               # Next, we need a "series" column that can be indexed to pick each time series
               # In this case, it is species names because we have 1 time series per species
               names_to = "series", # move species names into a "series" column
               
               # Finally, the response variable (what we measured) should be in
               # a "y" column
               values_to = "y") # move biomass values into a "y" column
```

\[stuff\]

## Part 2: Dynamic (and Hierarchical!) Generalized Additive Models

### Why "dynamic"?

Above, we modelled species' biomass fluctuations through time with a hierarchical structure to understand how different species' biomasses changed through time.

Before we continue, let's "zoom out" a little and think about how our model relates to ecology. Our model is saying that species' biomasses changed through time, and that these changes vary across species (some species' biomasses increased, others decreased, and others stayed pretty stable). All we have to explain biomass change through time is (1) time itself, and (2) species. Time was a linear predictor, and species was a factor variable used to structure the observations according to species.

Are there other factors that could explain why species' biomasses changed through time during this period? Yes, absolutely! There are factors like commercial fishing, climate variations, species interactions, and more at play in this community. These factors all leave an "imprint" in the time series we have here. And most importantly, these factors **vary through time** - they are themselves time series with their own temporal patterns.

The model we will be building in this section is a **dynamic factor model:** it assumes the factors that predict our response variable (i.e. biomass) evolve as time series.

**But, do we have any measured predictors to add to the model to capture the influence of these factors?** Unfortunately, as is often the case in ecological studies, we do not\* have measurements of these predictors through time.

*(\*The study from which we are borrowing the data actually **does** have some explanatory predictors we could add here - but let's pretend we don't know that!)*

There are three important things to think about here:

1.  There are **unmeasured predictors** that influence the trend we measured and are now modelling. The signature of these unmeasured processes is in the data, but we cannot capture it with the previous model because we did not include these predictors (all we had was time and species to explain the biomass trends). This is called **"latent variation"**;

2.  These processes are not static - they are **dynamic** (hey! that's in the name of the model!). Like our response variable, these unmeasured predictors **vary through time** (and are not linear either!).

    -   For example, commercial fishing pressure was high in the 1980s to mid-1990s and was then significantly reduced in the late 1990s onward. We can think similarly about climate fluctuating through time.

3.  Each species responds to these unmeasured predictors in their own way. (This is where the **"hierarchical"** bit comes back in!)

### Pause: Let's talk *latents*

You may have noticed that we slipped a new term into the previous section: "latent variation". The definition of "latent" in the Merriam-Webster dictionary is:

> Present and capable of emerging or developing but not now visible, obvious, active, or symptomatic.
>
> OR
>
> a fingerprint (as at the scene of a crime) that is scarcely visible but can be developed for study

It can be helpful to use this definition to conceptualise latent variation in our data. As we said above, there are "imprints" of factors that we didn't measure on the biomass time series we are modelling. These signals are present and influence the trends we estimate, but are "scarcely visible" because we lack information to detect them with time and species names alone. But - we can develop them for study!

In statistical models, latent variables are essentially random predictors that are generated during the modelling process to capture correlated variations between multiple responses (species, for example). The idea is that a bunch of these latent variables are randomly generated, and they are penalized until the model only retains a minimal set of latent variables that capture the main axes of covariation between responses. (Here, it can be useful to think of how a PCA reduces the dimensions of a dataset to a minimum of informative "axes").

In a latent temporal model, these latent variables condense the variation that is left unexplained into a "predictor" that capture some structured pattern across responses (e.g. species' biomass trends) through time. Each species is assigned a "factor loading" for each latent variable, which represents the species' response to the latent variable.

```{r}

```
